<template>
	<PageLayout>

		<FilterBarMobile />

		<Overlay v-model="errorModel" :text="errorMessage" icon="mdi-alert-circle-outline" color="error" />

		<ListView v-if="showList" />

		<CollectionView v-else/>

		<TitleDetail v-model="updateTitleDialog"
			:title="collection.selectedUserTitle"
			:is-delete-enabled="true"
			@save-title-data="(data, id) => collection.updateUserItem(id, data)"
			@delete-title="(id) => collection.deleteUserItem(id)"
			@clear-selection-data="collection.clearUserTitleData()" />

		<TitleDetail v-model="addSearchDialog"
			:title="collection.selectedSearch"
			:is-delete-enabled="false"
			@save-title-data="(data) => collection.addUserItem(data)"
			@clear-selection-data="collection.clearSearchData()" />

	</PageLayout>
</template>

<script setup lang="ts">
import { computed, onBeforeMount, ref, watch } from 'vue'
import { useMainStore } from '@/store'
import { useCollectionStore } from '@/store/collection'
import PageLayout from '@/components/navigation/PageLayout.vue'
import FilterBarMobile from '@/components/filter/FilterBarMobile.vue'
import Overlay from '@/components/Overlay.vue'
import CollectionView from '@/components/CollectionView.vue'
import ListView from '@/components/ListView.vue'
import TitleDetail from '@/components/title/TitleDetail.vue'

const store = useMainStore()
const collection = useCollectionStore()

const addSearchDialog = ref(false)
const updateTitleDialog = ref(false)

const errorMessage = computed(() => {
	return !!store.errorMessage ? store.errorMessage : `Error`
})

const showList = computed(() => {
	return !!collection.selectedList?.name
})

const errorModel = computed({
	get() {
		return store.isErrored
	},
	set(val: boolean) {
		if (!val) {
			store.setIsErrored(false, '')
		}
	}
})

onBeforeMount(() => {
	collection.loadCollection()
})

watch(() => collection.selectedSearch, (newValue) => {
	if (!!newValue?.title) {
		addSearchDialog.value = true
	}
})

watch(() => collection.selectedUserTitle, (newValue) => {
	if (!!newValue?.title) {
		updateTitleDialog.value = true
	}
})

</script>
